<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Meril Tender Extraction — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f5f9ff;
      --panel:#ffffff;
      --accent:#0b66ff;
      --accent-2:#0b9bff;
      --muted:#6b7280;
      --card-shadow: 0 12px 30px rgba(11,102,255,0.06);
      --radius:12px;
      --gap:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#0b2447}

    /* Top bar */
    header.appbar{
      height:70px;display:flex;align-items:center;gap:18px;padding:0 28px;background:#fff;border-bottom:1px solid rgba(11,102,255,0.06);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{font-size:18px;color:var(--accent);margin:0;font-weight:800}
    .brand .tag{font-size:13px;color:var(--muted)}

    /* Layout */
    main{height:calc(100vh - 70px);padding:18px 28px;display:flex;gap:20px}
    .left{flex:1;display:flex;flex-direction:column;gap:16px;min-width:0}
    .right{width:420px;display:flex;flex-direction:column;gap:16px;flex-shrink:0}

    .panel{background:var(--panel);border-radius:var(--radius);box-shadow:var(--card-shadow);padding:16px;display:flex;flex-direction:column;min-height:0}
    .section-title{font-weight:800;color:#07214b;margin-bottom:10px;font-size:14px}

    /* KPIs */
    .kpis{display:flex;gap:12px}
    .kpi{flex:1;background:#f8fbff;padding:12px;border-radius:10px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:26px;font-weight:800;color:#08326b;margin-top:6px}

    .progress{height:12px;background:#eaf3ff;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar{height:100%;background:linear-gradient(90deg,var(--accent),#4da6ff);width:0%}

    /* Timeline */
    .timeline-wrap { display:flex; flex-direction:column; gap:8px; min-height:0; flex:1; }
    .timeline { display:flex; flex-direction:column-reverse; gap:10px; min-height:0; overflow:auto; padding-right:6px; }
    /* set a max height inside the panel so the timeline can scroll cleanly */
    .panel.timeline-panel { padding:12px; }
    .timeline-list{display:flex;flex-direction:column-reverse;gap:10px;min-height:0}

    .titem{display:grid;grid-template-columns:76px 1fr;gap:10px;align-items:flex-start;min-height:44px}
    .tstamp{display:flex;flex-direction:column;align-items:flex-start;gap:6px;font-size:12px;color:var(--muted);min-height:0}
    .tstamp .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 6px 14px rgba(11,102,255,0.12);margin-bottom:6px}
    .tstamp .time{font-size:12px;color:var(--muted);line-height:1}

    .tcontent{background:#fbfdff;border:1px solid rgba(11,102,255,0.04);padding:10px;border-radius:10px;display:flex;flex-direction:column;justify-content:center;min-height:0}
    .tcontent .msg{font-size:13px;color:#073b6a;line-height:1.25;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;white-space:normal}
    .tcontent .meta{font-size:11px;color:var(--muted);margin-top:6px}

    /* Messages box */
    .messages{font-family:monospace;background:#f1f7ff;padding:12px;border-radius:10px;color:#073b6a;flex:1;min-height:0;overflow:hidden;white-space:pre-wrap}

    /* custom scrollbar for timeline (subtle) */
    .timeline::-webkit-scrollbar{width:10px}
    .timeline::-webkit-scrollbar-track{background:transparent;border-radius:8px}
    .timeline::-webkit-scrollbar-thumb{background:rgba(11,102,255,0.12);border-radius:8px}
    .timeline::-webkit-scrollbar-thumb:hover{background:rgba(11,102,255,0.18)}

    /* Firefox */
    .timeline { scrollbar-width: thin; scrollbar-color: rgba(11,102,255,0.12) transparent; }

    /* Utilities */
    .muted{color:var(--muted)}
    .file-link{color:var(--accent);font-weight:700;text-decoration:none}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand" aria-hidden="true">
      <svg width="42" height="42" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="6" fill="#0b66ff"></rect><path d="M7 12h10M7 7h10M7 17h10" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg>
      <div>
        <h1>Meril Tender Extraction</h1>
        <div class="tag">Live extraction dashboard</div>
      </div>
    </div>

    <div style="margin-left:auto;display:flex;align-items:center;gap:12px">
      <div class="muted">Status: <strong id="stage_small">IDLE</strong></div>
      <button onclick="location.reload()" style="background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700">Refresh</button>
    </div>
  </header>

  <main>
    <div class="left">
      <div class="panel" style="flex:0.9">
        <div class="section-title">Overall status</div>
        <div style="font-weight:800;font-size:16px;color:#07214b" id="message">Waiting to start</div>
        <div class="muted" style="margin-top:6px">The timeline shows page-level scraping & system messages.</div>

        <div style="margin-top:14px" class="kpis">
          <div class="kpi">
            <div class="label">Scraped records</div>
            <div id="scraped" class="value">0</div>
            <div class="muted" style="margin-top:6px">Pages: <span id="scraped_pages">0</span></div>
          </div>
          <div class="kpi">
            <div class="label">PDFs downloaded</div>
            <div id="download_done" class="value">0</div>
            <div class="muted" style="margin-top:6px">of <span id="download_total">0</span></div>
            <div class="progress"><div id="download_bar" class="bar"></div></div>
          </div>
          <div class="kpi">
            <div class="label">JSONs extracted</div>
            <div id="extract_done" class="value">0</div>
            <div class="muted" style="margin-top:6px">of <span id="extract_total">0</span></div>
            <div class="progress"><div id="extract_bar" class="bar"></div></div>
          </div>
        </div>
      </div>

      <div class="panel" style="flex:1.1">
        <div class="section-title">Messages / Errors</div>
        <div class="messages" id="messages"><pre>No messages yet.</pre></div>
      </div>
    </div>

    <div class="right">
      <div class="panel timeline-panel" style="flex:1">
        <div class="section-title">Live timeline</div>
        <div class="timeline-wrap">
          <!-- timeline is scrollable -->
          <div id="timeline" class="timeline" aria-live="polite" aria-atomic="true">
            <div class="timeline-list">
              <div class="titem">
                <div class="tstamp">
                  <div class="dot"></div>
                  <div class="time">--:--:--</div>
                </div>
                <div class="tcontent">
                  <div class="msg">No activity yet</div>
                  <div class="meta muted">Start the pipeline to see logs</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel" style="flex:0.45">
        <div class="section-title">Quick links</div>
        <div style="display:flex;gap:12px;align-items:center">
          <a class="file-link" href="./status.json" target="_blank">Open status.json</a>
          <a class="file-link" href="./download_map.csv" target="_blank">download_map.csv</a>
        </div>
      </div>
    </div>
  </main>

  <script>
    const statusUrl = "./status.json";
    let lastHash = "";

    function hashArr(a){ return a ? a.join("|").slice(-2000) : ""; }
    function timeNow(){ return new Date().toLocaleTimeString(); }

    function buildItem(tsText, msgText){
      const item = document.createElement("div"); item.className="titem";
      const stamp = document.createElement("div"); stamp.className="tstamp";
      const dot = document.createElement("div"); dot.className="dot";
      const time = document.createElement("div"); time.className="time"; time.textContent = tsText || timeNow();
      stamp.appendChild(dot); stamp.appendChild(time);

      const content = document.createElement("div"); content.className="tcontent";
      content.title = msgText || "";
      const msg = document.createElement("div"); msg.className="msg"; msg.textContent = msgText || "";
      const meta = document.createElement("div"); meta.className="meta muted";
      content.appendChild(msg); content.appendChild(meta);

      item.appendChild(stamp); item.appendChild(content);
      return item;
    }

    async function updateStatus(){
      try{
        const r = await fetch(statusUrl + "?_=" + Date.now());
        if(!r.ok) return;
        const s = await r.json();

        // KPIs
        document.getElementById("stage_small").textContent = (s.stage || "idle").toUpperCase();
        document.getElementById("message").textContent = s.message || "Waiting to start";
        document.getElementById("scraped").textContent = s.scraped_records || 0;
        document.getElementById("scraped_pages").textContent = s.scraped_pages || 0;
        document.getElementById("download_total").textContent = s.download_total || 0;
        document.getElementById("download_done").textContent = s.download_done || 0;
        document.getElementById("extract_total").textContent = s.extract_total || 0;
        document.getElementById("extract_done").textContent = s.extract_done || 0;
        // full_data_path may not exist in older statuses
        if(document.getElementById("full_data_path")) document.getElementById("full_data_path").textContent = s.full_data_path || "—";

        // bars
        const pctD = (s.download_total ? Math.round((s.download_done||0)/s.download_total * 100) : (s.stage==='done'?100:0));
        const pctE = (s.extract_total ? Math.round((s.extract_done||0)/s.extract_total * 100) : (s.stage==='done'?100:0));
        document.getElementById("download_bar").style.width = pctD + "%";
        document.getElementById("extract_bar").style.width = pctE + "%";

        // messages/errors
        const errors = Array.isArray(s.errors) ? s.errors.slice(-6) : [];
        const msgs = [];
        if(s.message) msgs.push(s.message);
        if(errors.length) msgs.push("Errors: " + errors.join("; "));
        if(msgs.length===0) msgs.push("No messages yet.");
        document.getElementById("messages").innerHTML = "<pre>" + msgs.join("\n") + "</pre>";

        // timeline: prefer s.log
        const logArr = Array.isArray(s.log) ? s.log.slice(-200) : (s.message ? [s.message] : []);
        const h = hashArr(logArr);
        if(h !== lastHash){
          lastHash = h;
          const timeline = document.getElementById("timeline");
          timeline.innerHTML = ""; // clear
          const show = logArr.slice(-200); // show up to 200 entries
          // append newest last so scrolling natural (we display reverse in CSS)
          for(let i = 0; i < show.length; i++){
            const text = show[i] || "";
            // try to extract a short timestamp if present in message (e.g. [12:34:56])
            const tsMatch = text.match(/\[?(\d{1,2}:\d{2}:\d{2}(?:\s?[APMapm]{2})?)\]?/);
            const ts = tsMatch ? tsMatch[1] : timeNow();
            const it = buildItem(ts, text);
            timeline.appendChild(it);
          }
          // after rebuild, scroll to top (latest entries appear visually at top because of column-reverse)
          timeline.scrollTop = timeline.scrollHeight;
        }

      }catch(e){}
    }

    // initial + interval
    updateStatus();
    setInterval(updateStatus, 800);
  </script>
</body>
</html>
